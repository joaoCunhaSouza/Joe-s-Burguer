{% extends 'kitchen_base.html' %}
{% block title %}Cozinha - Pedidos{% endblock %}
{% block content %}
<div class="kitchen-card">
  <h2>Fila de Pedidos</h2>
  <table class="kitchen-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Cliente</th>
        <th>Total</th>
        <th>Status</th>
        <th>Criado</th>
      </tr>
    </thead>
    <tbody>
      {% for o in orders %}
      <tr>
        <td><a href="{% url 'kitchen_order_detail' o.id %}" style="color: #ff4d4d; text-decoration: none; font-weight: 600;">{{ o.id }}</a></td>
        <td><a href="{% url 'kitchen_order_detail' o.id %}" style="color: #333; text-decoration: none;">{{ o.customer_name }}</a></td>
        <td><strong>R$ {{ o.total }}</strong></td>
        <td>
          {% if o.status == 'new' %}
            <span style="color: #ff4d4d; font-weight: 600;">{{ o.get_status_display }}</span>
          {% elif o.status == 'preparing' %}
            <span style="color: #333; font-weight: 600;">{{ o.get_status_display }}</span>
          {% else %}
            <span style="color: #999; font-weight: 600;">{{ o.get_status_display }}</span>
          {% endif %}
        </td>
        <td>{{ o.created_at|date:"d/m/Y H:i" }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="5" style="text-align: center; padding: 2rem; color: #999;">Nenhum pedido ativo no momento</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Poll the kitchen orders JSON endpoint every 8 seconds and update the table body.
const kitchenPollInterval = 8000;
async function fetchOrdersAndRender(){
  try{
    const resp = await fetch('{% url "kitchen_orders_json" %}', {credentials: 'same-origin'});
    if(!resp.ok) return;
    const data = await resp.json();
    const tbody = document.querySelector('table.kitchen-table tbody');
    if(!tbody) return;
    tbody.innerHTML = '';
    if(!data.orders || data.orders.length === 0){
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="5" style="text-align: center; padding: 2rem; color: #999;">Nenhum pedido ativo no momento</td>';
      tbody.appendChild(tr);
      return;
    }
    data.orders.forEach(o => {
      const tr = document.createElement('tr');
      let statusColor = '#999';
      if(o.status === 'Novo') statusColor = '#ff4d4d';
      else if(o.status === 'Em preparação') statusColor = '#333';
      
      tr.innerHTML = `<td><a href="/kitchen/order/${o.id}/" style="color: #ff4d4d; text-decoration: none; font-weight: 600;">${o.id}</a></td>`+
                     `<td><a href="/kitchen/order/${o.id}/" style="color: #333; text-decoration: none;">${o.customer_name}</a></td>`+
                     `<td><strong>R$ ${o.total}</strong></td>`+
                     `<td><span style="color: ${statusColor}; font-weight: 600;">${o.status}</span></td>`+
                     `<td>${new Date(o.created_at).toLocaleString('pt-BR')}</td>`;
      tbody.appendChild(tr);
    });
  }catch(e){
    // silent fail; next poll will try again
    console.error('kitchen poll error', e);
  }
}

// Start polling when page loads
document.addEventListener('DOMContentLoaded', function(){
  // initial fetch
  fetchOrdersAndRender();
  setInterval(fetchOrdersAndRender, kitchenPollInterval);
});
</script>
{% endblock %}
